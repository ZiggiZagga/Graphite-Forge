version: "3.8"

services:

  # Edge Gateway (Spring Cloud Gateway)
  edge-gateway:
    image: edge-gateway:native
    build:
      context: ./edge-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=default
    ports:
      - "8080:8080"
    networks:
      - graphite-forge-network
      - steel-hammer_steel-hammer-network

  # GraphQL Service
  graphql-service:
    image: graphql-service:native
    build:
      context: ./graphql-service
    environment:
      - SPRING_PROFILES_ACTIVE=default
    ports:
      - "8081:8081"
    networks:
      - graphite-forge-network
      - steel-hammer_steel-hammer-network

  # E2E Test Runner (runs in same network)
  e2e-tests:
    build:
      context: ./scripts
      dockerfile: Dockerfile.e2e
    depends_on:
      - graphql-service
      - edge-gateway
    environment:
      - GATEWAY_URL=http://edge-gateway:8080
      - GRAPHQL_URL=http://graphql-service:8081
      - KEYCLOAK_URL=http://steel-hammer-keycloak:7081
      - MINIO_URL=http://steel-hammer-minio:9000
    networks:
      - graphite-forge-network
      - steel-hammer_steel-hammer-network
    profiles:
      - testing

networks:
  graphite-forge-network:
    driver: bridge
  steel-hammer_steel-hammer-network:
    external: true
