version: "3.8"

services:

  # Edge Gateway (Spring Cloud Gateway)
  edge-gateway:
    hostname: edge-gateway
    container_name: edge-gateway
    build:
      context: ./edge-gateway
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_APPLICATION_NAME=edge-gateway
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - KEYCLOAK_URL=http://steel-hammer-keycloak:7081
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=http://steel-hammer-keycloak:7081/realms/master
      - EUREKA_URI=http://steel-hammer-buzzle-vane:8083/eureka
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317
      - MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - graphite-forge-network
      - steel-hammer-network
    restart: "always"

  # GraphQL Service
  graphql-service:
    hostname: graphql-service
    container_name: graphql-service
    build:
      context: ./graphql-service
      dockerfile: Dockerfile
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_APPLICATION_NAME=graphql-service
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - KEYCLOAK_URL=http://steel-hammer-keycloak:7081
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=http://steel-hammer-keycloak:7081/realms/master
      - MINIO_URL=http://steel-hammer-minio:9000
      - EUREKA_URI=http://steel-hammer-buzzle-vane:8083/eureka
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://localhost:4317
      - MANAGEMENT_METRICS_TAGS_ENVIRONMENT=docker
      - DATABASE_URL=r2dbc:h2:mem:///testdb?options=DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - graphite-forge-network
      - steel-hammer-network
    restart: "always"

  # E2E Test Runner (runs in same network)
  e2e-tests:
    hostname: e2e-tests
    container_name: graphite-forge-e2e-tests
    build:
      context: ./scripts
      dockerfile: Dockerfile.e2e
    depends_on:
      - graphql-service
      - edge-gateway
    environment:
      - GATEWAY_URL=http://edge-gateway:8080
      - GRAPHQL_URL=http://graphql-service:8083
      - KEYCLOAK_URL=http://steel-hammer-keycloak:7081
      - MINIO_URL=http://steel-hammer-minio:9000
    networks:
      - graphite-forge-network
      - steel-hammer-network
    profiles:
      - testing

networks:
  graphite-forge-network:
    name: graphite-forge-network
    driver: bridge
  steel-hammer-network:
    name: steel-hammer_steel-hammer-network
    external: true
