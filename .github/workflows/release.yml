name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION" >> $GITHUB_STEP_SUMMARY
      
      - name: Validate semantic version
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid semantic version: $VERSION"
            exit 1
          fi
          echo "âœ… Valid semantic version: $VERSION"

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate-tag
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
      
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json
      
      - name: Build config-server
        run: |
          cd config-server
          mvn clean package -DskipTests
          mv target/*.jar target/config-server-${{ needs.validate-tag.outputs.version }}.jar
      
      - name: Build graphql-service
        run: |
          cd graphql-service
          mvn clean package -DskipTests
          mv target/*.jar target/graphql-service-${{ needs.validate-tag.outputs.version }}.jar
      
      - name: Build edge-gateway
        run: |
          cd edge-gateway
          mvn clean package -DskipTests
          mv target/*.jar target/edge-gateway-${{ needs.validate-tag.outputs.version }}.jar
      
      - name: Build UI
        run: |
          cd ui
          npm ci
          npm run build
          tar -czf ui-build-${{ needs.validate-tag.outputs.version }}.tar.gz .next out
      
      - name: Generate checksums
        run: |
          cd config-server/target && sha256sum config-server-${{ needs.validate-tag.outputs.version }}.jar > config-server-${{ needs.validate-tag.outputs.version }}.jar.sha256
          cd ../../graphql-service/target && sha256sum graphql-service-${{ needs.validate-tag.outputs.version }}.jar > graphql-service-${{ needs.validate-tag.outputs.version }}.jar.sha256
          cd ../../edge-gateway/target && sha256sum edge-gateway-${{ needs.validate-tag.outputs.version }}.jar > edge-gateway-${{ needs.validate-tag.outputs.version }}.jar.sha256
          cd ../../ui && sha256sum ui-build-${{ needs.validate-tag.outputs.version }}.tar.gz > ui-build-${{ needs.validate-tag.outputs.version }}.tar.gz.sha256
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            config-server/target/config-server-${{ needs.validate-tag.outputs.version }}.jar
            config-server/target/config-server-${{ needs.validate-tag.outputs.version }}.jar.sha256
            graphql-service/target/graphql-service-${{ needs.validate-tag.outputs.version }}.jar
            graphql-service/target/graphql-service-${{ needs.validate-tag.outputs.version }}.jar.sha256
            edge-gateway/target/edge-gateway-${{ needs.validate-tag.outputs.version }}.jar
            edge-gateway/target/edge-gateway-${{ needs.validate-tag.outputs.version }}.jar.sha256
            ui/ui-build-${{ needs.validate-tag.outputs.version }}.tar.gz
            ui/ui-build-${{ needs.validate-tag.outputs.version }}.tar.gz.sha256
          retention-days: 90

  build-docker-images:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: validate-tag
    strategy:
      matrix:
        service: [config-server, graphql-service, edge-gateway, ui]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/graphite-forge-${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate-tag
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.validate-tag.outputs.version }}
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            echo "Generating changelog from $PREV_TAG to v$VERSION"
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)")
          fi
          
          # Save changelog to file
          echo "$CHANGELOG" > CHANGELOG_$VERSION.txt
          
          # Set output (escape newlines for GitHub Actions)
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG_${{ needs.validate-tag.outputs.version }}.txt
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, build-artifacts, build-docker-images, generate-changelog]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: ./release-artifacts
      
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          path: ./
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ needs.validate-tag.outputs.version }}
          body_path: ./CHANGELOG_${{ needs.validate-tag.outputs.version }}.txt
          files: |
            release-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate release summary
        run: |
          VERSION=${{ needs.validate-tag.outputs.version }}
          echo "# Release v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… config-server JAR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… graphql-service JAR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… edge-gateway JAR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… UI build tarball" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/graphite-forge-config-server:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/graphite-forge-graphql-service:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/graphite-forge-edge-gateway:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/graphite-forge-ui:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG_$VERSION.txt >> $GITHUB_STEP_SUMMARY

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate-tag, create-release]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Release Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Tag | ${{ needs.validate-tag.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Create Release | ${{ needs.create-release.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- Version: v${{ needs.validate-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Release complete! View on [GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-tag.outputs.version }})" >> $GITHUB_STEP_SUMMARY
